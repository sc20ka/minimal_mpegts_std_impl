# Minimal MPEG-TS Standard Implementation

## 📖 Описание проекта

Минималистичная реализация MPEG-TS (ISO/IEC 13818-1) демультиплексора на C++17, созданная для образовательных целей и практического применения в задачах обработки транспортных потоков.

## 🎯 Назначение

Проект предоставляет чистую, профайл-агностичную реализацию демультиплексора MPEG-TS с фокусом на:

- **Потоковую обработку** MPEG-TS данных с высокой надёжностью
- **Адаптивную синхронизацию** в условиях помех и мусора
- **Восстановление** валидных пакетов из произвольных данных
- **Разделение** основной полезной нагрузки и приватных данных
- **Управление** несколькими программами и потоками одновременно

## ⚠️ Текущая стадия разработки

**ALPHA v0.1.0 - Core Demuxing Complete**

Проект завершил **Фазу 1: Базовый демультиплексинг** с полным функционалом:

### ✅ Реализовано (Фаза 1 - ЗАВЕРШЕНА)

- ✅ **Алгоритм 3-итеративной валидации** - надежная синхронизация с толерантностью к мусору
- ✅ **Адаптивная синхронизация** - восстановление после помех и шума
- ✅ **Извлечение payload** - разделение нормальных и приватных данных
- ✅ **Поддержка множественных PID** - обработка нескольких потоков одновременно
- ✅ **Отслеживание continuity counter** - детекция потери пакетов
- ✅ **Фильтрация системных PID** - автоматическое исключение PAT/CAT
- ✅ **Comprehensive test suite** - все 7 базовых тестов проходят
- ✅ **Генератор синтетических пакетов** - для тестирования различных сценариев

### 🚧 В разработке (Фаза 2)

- 🔨 Парсирование PAT/PMT - анализ таблиц программ
- 🔨 Обработка продвинутых сценариев - уточнение edge cases

### 📋 Запланировано (Фазы 2-3)

- ⏳ Обработка PCR - работа с clock reference
- ⏳ Декодирование PES - elementary stream пакеты
- ⏳ Оптимизации производительности - SIMD, zero-copy
- ⏳ Поддержка многопоточности
- ⏳ DVB-специфичные функции (опционально)

## 🏗️ Архитектура

### Ключевые компоненты

```
┌─────────────────────────────────────────┐
│  MPEG-TS Stream Input (raw bytes)      │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  Adaptive Buffer (18.8 KB circular)    │
│  - Accumulates packets                  │
│  - Handles garbage filtering            │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  Synchronization Engine                 │
│  - 0x47 sync byte detection             │
│  - 3-iteration validation               │
│  - Continuity counter check             │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  Stream Storage                         │
│  - PID-based organization               │
│  - Iteration tracking                   │
│  - Payload separation (normal/private)  │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  User API                               │
│  - feedData()                           │
│  - getPayload()                         │
│  - getIterations()                      │
└─────────────────────────────────────────┘
```

## 🛠️ Технические характеристики

| Параметр                  | Значение                           |
| ------------------------- | ---------------------------------- |
| Язык                      | C++17                              |
| Стандарт                  | ISO/IEC 13818-1 (MPEG-TS)          |
| Размер пакета             | 188 байт (без 192-byte mode)       |
| Буфер                     | 100 пакетов (18.8 KB)              |
| Валидация синхронизации   | 3-итеративная (trinary)            |
| Поддержка видеокодеков    | H.264, H.265 (любые MPEG-TS типы)  |
| Приватные данные          | Полная поддержка                   |
| Scrambled контент         | НЕ поддерживается                  |
| Профили                   | Profile-agnostic                   |

## 📦 Сборка проекта

### Требования

- CMake 3.15+
- Компилятор с поддержкой C++17 (GCC 7+, Clang 5+, MSVC 2017+)

### Сборка

```bash
# Клонирование репозитория
git clone <repository-url>
cd minimal_mpegts_std_impl

# Создание build директории
mkdir build && cd build

# Конфигурация с опциями
cmake -DBUILD_EXAMPLES=ON -DBUILD_TESTS=ON ..

# Сборка
cmake --build .

# Запуск тестов
./tests/test_demuxer_basic
./tests/test_demuxer_scenarios

# Или через CTest
ctest

# Запуск примера
./bin/basic_example input.ts
```

## 📚 Использование

### Базовый пример

```cpp
#include "mpegts_demuxer.hpp"

int main() {
    using namespace mpegts;
    MPEGTSDemuxer demuxer;

    // Подача данных из файла или потока
    uint8_t buffer[4096];
    size_t bytes_read = read_stream(buffer, sizeof(buffer));
    demuxer.feedData(buffer, bytes_read);

    // Проверка синхронизации
    if (demuxer.isSynchronized()) {
        // Получить обнаруженные программы
        auto programs = demuxer.getPrograms();

        for (const auto& prog : programs) {
            std::cout << "Найдено " << prog.stream_pids.size() << " потоков\n";

            for (uint16_t pid : prog.stream_pids) {
                // Получить итерации для данного PID
                auto iterations = demuxer.getIterationsSummary(pid);

                for (const auto& iter : iterations) {
                    // Извлечь payload
                    auto payload = demuxer.getPayload(pid, iter.iteration_id);

                    // Обработать данные payload
                    process_data(payload.data, payload.length);

                    // Очистить после обработки
                    demuxer.clearIteration(pid, iter.iteration_id);
                }
            }
        }
    }

    return 0;
}
```

Подробные примеры доступны в директории `examples/`.

## 📋 Roadmap

### Фаза 1: Core Demuxing ✅ (ЗАВЕРШЕНА)
- [x] Базовая структура проекта
- [x] Реализация адаптивного буфера
- [x] 3-итеративная синхронизация и валидация пакетов
- [x] Хранилище потоков с отслеживанием итераций
- [x] Полное API (feedData, getPrograms, getPayload, и т.д.)
- [x] Comprehensive test framework
- [x] Генератор синтетических пакетов

### Фаза 2: Advanced Features 🚧 (В РАЗРАБОТКЕ)
- [ ] Парсирование PAT/PMT
- [ ] Обработка PCR
- [ ] Декодирование PES
- [ ] Улучшенная обработка ошибок
- [ ] Статистика в реальном времени

### Фаза 3: Optimization & Extensions ⏳ (ЗАПЛАНИРОВАНО)
- [ ] Оптимизации производительности (SIMD, zero-copy)
- [ ] Поддержка многопоточности
- [ ] DVB-специфичные функции (опционально)
- [ ] Fuzz testing и hardening

## 🧪 Тестирование

Проект включает comprehensive test suite:

```bash
# Сборка с тестами
cmake -DBUILD_TESTS=ON ..
cmake --build .

# Запуск тестовых наборов
./tests/test_demuxer_basic       # 7/7 базовых функциональных тестов
./tests/test_demuxer_scenarios   # Сценарные тесты с мусором
./tests/test_synchronization     # Edge cases алгоритма синхронизации
```

**Покрытие тестами:**
- ✅ Валидация одиночного пакета
- ✅ Синхронизация на чистом потоке
- ✅ Обработка множественных PID
- ✅ Извлечение payload (normal + private)
- ✅ Отслеживание continuity counter
- ✅ Фильтрация системных PID
- ✅ Генерация синтетических пакетов с контролируемым мусором

## 📄 Документация

Полная техническая спецификация доступна в файле [todo.md](todo.md).

Английская документация: [README.md](README.md)

## 📜 Лицензия

См. файл [LICENSE](LICENSE)

## 🤝 Контрибуция

Проект находится на ранней стадии разработки. Контрибуции приветствуются после завершения core функционала.

## ⚡ Статус

- **Версия:** 0.1.0-alpha
- **Статус:** Фаза 1 Завершена ✅ | Фаза 2 В Разработке 🚧
- **Покрытие тестами:** 7/7 базовых тестов проходят
- **Последнее обновление:** November 2025

### Последние обновления

- ✅ **Core синхронизация завершена** - 3-итеративная валидация работает
- ✅ **Добавлен test framework** - comprehensive testing infrastructure
- ✅ **Извлечение payload завершено** - поддержка normal + private данных
- 🔨 **В работе:** Парсирование PAT/PMT и продвинутые сценарии

---

**Примечание:** Это образовательный проект с фокусом на чистую реализацию стандарта MPEG-TS. Для production использования рекомендуется libavformat (FFmpeg) или аналогичные зрелые библиотеки.
